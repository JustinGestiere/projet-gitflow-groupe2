name: V√©rification du changelog

on:
  push:
    branches:
      - "**"
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify_changelog:
    name: V√©rifier la coh√©rence entre CHANGELOG.md et les tags Git
    runs-on: ubuntu-latest

    steps:
      - name: R√©cup√©rer le code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: V√©rifier la pr√©sence du fichier CHANGELOG.md
        run: |
          if [ ! -f "CHANGELOG.md" ]; then
            echo "‚ùå Le fichier CHANGELOG.md est introuvable √† la racine du d√©p√¥t."
            echo "Veuillez cr√©er un fichier CHANGELOG.md listant les changements pour chaque version."
            exit 1
          else
            echo "‚úÖ Fichier CHANGELOG.md trouv√©."
          fi

      - name: "Identifier le dernier tag Git (format attendu : vMAJOR.MINOR.PATCH)"
        id: get_tag
        run: |
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          if [[ "$last_tag" == "none" ]]; then
            echo "‚ùå Aucun tag Git n‚Äôa √©t√© trouv√© dans le d√©p√¥t."
            echo "Veuillez cr√©er un tag de version (ex: v1.0.0) avant de relancer le workflow."
            exit 1
          fi

          if [[ ! "$last_tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Le dernier tag ($last_tag) ne respecte pas le format attendu : vMAJOR.MINOR.PATCH (ex: v1.2.3)."
            exit 1
          fi

          echo "‚úÖ Dernier tag d√©tect√© : $last_tag"
          echo "TAG=$last_tag" >> $GITHUB_ENV

      - name: V√©rifier que le changelog mentionne la derni√®re version
        run: |
          tag="${TAG}"

          if grep -q "$tag" CHANGELOG.md; then
            echo "‚úÖ Le fichier CHANGELOG.md contient bien une section pour la version $tag."
          else
            echo "‚ùå Le fichier CHANGELOG.md ne contient pas de r√©f√©rence √† la version $tag."
            echo ""
            echo "üëâ Pour corriger : ajoutez une section similaire √† ceci dans CHANGELOG.md :"
            echo ""
            echo "## $tag"
            echo "- Description des changements de cette version"
            exit 1
          fi
